<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trades Tab Browser Validation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .test-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-running {
            background-color: #cce5ff;
            color: #004085;
        }
        .status-pass {
            background-color: #d4edda;
            color: #155724;
        }
        .status-fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        .test-details {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .summary h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.8;
        }
        .error-details {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            color: #cf1322;
        }
        .success-details {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            color: #389e0d;
        }
        button {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background-color: #40a9ff;
        }
        button:disabled {
            background-color: #d9d9d9;
            cursor: not-allowed;
        }
        .log-container {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-info { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warn { color: #ff9800; }
    </style>
</head>
<body>
    <h1>üîç Trades Tab Comprehensive Validation</h1>
    
    <div class="summary">
        <h2>Validation Progress</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
        </div>
        <div class="summary-stats">
            <div class="stat-item">
                <span class="stat-number" id="totalTests">0</span>
                <span class="stat-label">Total Tests</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="passedTests">0</span>
                <span class="stat-label">Passed</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="failedTests">0</span>
                <span class="stat-label">Failed</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="successRate">0%</span>
                <span class="stat-label">Success Rate</span>
            </div>
        </div>
        <button id="startValidation" onclick="startValidation()">Start Validation</button>
        <button id="exportResults" onclick="exportResults()" disabled>Export Results</button>
    </div>

    <div id="testResults"></div>

    <div class="log-container" id="logContainer">
        <div class="log-entry log-info">Validation log will appear here...</div>
    </div>

    <script>
        // Configuration
        const BASE_URL = 'http://localhost:3000';
        const TRADES_URL = `${BASE_URL}/trades`;
        const API_ENDPOINTS = {
            trades: `${BASE_URL}/api/confluence-trades`,
            stats: `${BASE_URL}/api/confluence-stats`
        };

        // Test results storage
        let validationResults = {
            timestamp: new Date().toISOString(),
            summary: {
                totalTests: 0,
                passed: 0,
                failed: 0,
                warnings: 0
            },
            tests: {},
            performance: {},
            errors: [],
            recommendations: []
        };

        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress() {
            const total = validationResults.summary.totalTests;
            const passed = validationResults.summary.passed;
            const failed = validationResults.summary.failed;
            const progress = total > 0 ? ((passed + failed) / total * 100) : 0;
            const successRate = total > 0 ? (passed / total * 100).toFixed(1) : 0;

            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('successRate').textContent = `${successRate}%`;
        }

        function createTestContainer(category, testName, description) {
            const container = document.createElement('div');
            container.className = 'test-container';
            container.id = `test-${category}-${testName.replace(/\s+/g, '-').toLowerCase()}`;
            
            container.innerHTML = `
                <div class="test-header">
                    <div class="test-title">${category}: ${testName}</div>
                    <div class="test-status status-pending" id="status-${container.id}">PENDING</div>
                </div>
                <div class="test-details" id="details-${container.id}">${description}</div>
            `;
            
            document.getElementById('testResults').appendChild(container);
            return container.id;
        }

        function updateTestStatus(testId, status, details = '') {
            const statusElement = document.getElementById(`status-${testId}`);
            const detailsElement = document.getElementById(`details-${testId}`);
            
            if (statusElement) {
                statusElement.className = `test-status status-${status}`;
                statusElement.textContent = status.toUpperCase();
            }
            
            if (detailsElement && details) {
                detailsElement.innerHTML = details;
            }
        }

        function recordTest(category, testName, passed, details = '') {
            const testId = createTestContainer(category, testName, details);
            
            validationResults.summary.totalTests++;
            if (passed) {
                validationResults.summary.passed++;
            } else {
                validationResults.summary.failed++;
            }
            
            if (!validationResults.tests[category]) {
                validationResults.tests[category] = [];
            }
            
            validationResults.tests[category].push({
                name: testName,
                passed,
                details,
                timestamp: new Date().toISOString()
            });
            
            updateTestStatus(testId, passed ? 'pass' : 'fail', details);
            updateProgress();
            
            log(`${category}: ${testName} - ${passed ? 'PASS' : 'FAIL'} ${details}`, passed ? 'info' : 'error');
        }

        async function makeRequest(url, options = {}) {
            const startTime = Date.now();
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                const duration = Date.now() - startTime;
                let data;
                
                try {
                    data = await response.json();
                } catch (e) {
                    data = await response.text();
                }
                
                return {
                    status: response.status,
                    ok: response.ok,
                    data,
                    duration,
                    headers: Object.fromEntries(response.headers.entries())
                };
            } catch (error) {
                const duration = Date.now() - startTime;
                return {
                    status: 0,
                    ok: false,
                    data: { error: error.message },
                    duration,
                    headers: {}
                };
            }
        }

        // Validation functions
        async function validatePageAccessibility() {
            log('Starting page accessibility validation...');
            
            // Test 1: Check if trades page loads
            const result = await makeRequest(TRADES_URL);
            recordTest(
                'Page Accessibility',
                'Trades page loads successfully',
                result.status === 200,
                `Status: ${result.status}, Duration: ${result.duration}ms`
            );
            
            // Test 2: Check if page contains expected elements
            if (result.ok) {
                const pageText = await result.data.text ? result.data.text : '';
                const hasTradeElements = pageText.includes('Trade History') || pageText.includes('trades');
                const hasFilterElements = pageText.includes('Filters') || pageText.includes('filter');
                const hasStatsElements = pageText.includes('Total Trades') || pageText.includes('Win Rate');
                
                recordTest(
                    'Page Accessibility',
                    'Page contains expected UI elements',
                    hasTradeElements && hasFilterElements && hasStatsElements,
                    `Trade Elements: ${hasTradeElements}, Filters: ${hasFilterElements}, Stats: ${hasStatsElements}`
                );
            }
        }

        async function validateAPIEndpoints() {
            log('Starting API endpoints validation...');
            
            // Test 1: Check trades API endpoint
            const tradesResult = await makeRequest(API_ENDPOINTS.trades);
            recordTest(
                'API Endpoints',
                'Trades API endpoint is accessible',
                tradesResult.status === 401 || tradesResult.status === 200,
                `Status: ${tradesResult.status}, Duration: ${tradesResult.duration}ms`
            );
            
            // Test 2: Check stats API endpoint
            const statsResult = await makeRequest(API_ENDPOINTS.stats);
            recordTest(
                'API Endpoints',
                'Stats API endpoint is accessible',
                statsResult.status === 401 || statsResult.status === 200,
                `Status: ${statsResult.status}, Duration: ${statsResult.duration}ms`
            );
        }

        async function validateErrorHandling() {
            log('Starting error handling validation...');
            
            // Test 1: Check API error responses
            const tradesResult = await makeRequest(API_ENDPOINTS.trades);
            const hasStructuredError = tradesResult.data && (
                tradesResult.data.error || 
                tradesResult.data.requestId ||
                tradesResult.data.details
            );
            
            recordTest(
                'Error Handling',
                'API provides structured error responses',
                hasStructuredError,
                `Has Error Structure: ${hasStructuredError}`
            );
        }

        async function validatePerformance() {
            log('Starting performance validation...');
            
            // Test 1: Check page load time
            const startTime = Date.now();
            const pageResult = await makeRequest(TRADES_URL);
            const pageLoadTime = Date.now() - startTime;
            
            recordTest(
                'Performance',
                'Page loads within acceptable time',
                pageLoadTime < 3000,
                `Load Time: ${pageLoadTime}ms`
            );
            
            // Test 2: Check API response times
            const apiResult = await makeRequest(API_ENDPOINTS.trades);
            recordTest(
                'Performance',
                'API responds within acceptable time',
                apiResult.duration < 2000,
                `API Response Time: ${apiResult.duration}ms`
            );
        }

        async function validateDataFlow() {
            log('Starting data flow validation...');
            
            // This would require authentication, so we'll check if the infrastructure is in place
            const pageResult = await makeRequest(TRADES_URL);
            const pageText = await pageResult.data.text ? pageResult.data.text : '';
            
            const hasDataFetching = pageText.includes('fetch') || pageText.includes('useEffect');
            const hasStateManagement = pageText.includes('useState') || pageText.includes('setTrades');
            const hasErrorHandling = pageText.includes('try') && pageText.includes('catch');
            
            recordTest(
                'Data Flow',
                'Frontend has proper data flow infrastructure',
                hasDataFetching && hasStateManagement && hasErrorHandling,
                `Data Fetching: ${hasDataFetching}, State Management: ${hasStateManagement}, Error Handling: ${hasErrorHandling}`
            );
        }

        async function runAllTests() {
            log('Starting comprehensive validation...');
            
            await validatePageAccessibility();
            await validateAPIEndpoints();
            await validateErrorHandling();
            await validatePerformance();
            await validateDataFlow();
            
            // Generate overall assessment
            const successRate = validationResults.summary.totalTests > 0 
                ? (validationResults.summary.passed / validationResults.summary.totalTests * 100).toFixed(2)
                : 0;
            
            validationResults.summary.successRate = `${successRate}%`;
            
            if (parseFloat(successRate) >= 90) {
                validationResults.overallStatus = 'EXCELLENT';
                validationResults.recommendations.push('All critical fixes are working correctly. The /trades tab should display data properly.');
            } else if (parseFloat(successRate) >= 75) {
                validationResults.overallStatus = 'GOOD';
                validationResults.recommendations.push('Most fixes are working, but some areas need attention.');
            } else if (parseFloat(successRate) >= 50) {
                validationResults.overallStatus = 'NEEDS_IMPROVEMENT';
                validationResults.recommendations.push('Several fixes need attention before /trades tab will work properly.');
            } else {
                validationResults.overallStatus = 'CRITICAL';
                validationResults.recommendations.push('Critical issues remain. The /trades tab may not function correctly.');
            }
            
            log(`Validation completed with status: ${validationResults.overallStatus}`);
            log(`Success rate: ${validationResults.summary.successRate}`);
            
            // Enable export button
            document.getElementById('exportResults').disabled = false;
        }

        function startValidation() {
            document.getElementById('startValidation').disabled = true;
            runAllTests();
        }

        function exportResults() {
            const dataStr = JSON.stringify(validationResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trades-validation-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Initialize
        log('Trades Tab Browser Validation Tool Ready');
        log(`Target URL: ${TRADES_URL}`);
        log('Click "Start Validation" to begin testing');
    </script>
</body>
</html>