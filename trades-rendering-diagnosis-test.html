<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trades Rendering Diagnosis Test</title>
    <style>
        body {
            font-family: monospace;
            background: #0a0a0a;
            color: #ffffff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #111;
        }
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #1d4ed8;
        }
        .console-output {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
        }
        .status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
        }
        .status.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
        }
        .iframe-container {
            width: 100%;
            height: 600px;
            border: 1px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Trades Rendering Diagnosis Test</h1>
        
        <div class="section">
            <h2>Test Instructions</h2>
            <p>This test will help diagnose why trades are not displaying in the UI despite being fetched correctly.</p>
            <ol>
                <li>Open the trades page in the application</li>
                <li>Copy and paste the diagnosis script below into the browser console on the trades page</li>
                <li>Run the diagnosis and analyze the output</li>
                <li>Check the findings below for potential issues</li>
            </ol>
        </div>

        <div class="section">
            <h2>Diagnosis Script</h2>
            <p>Copy this script and run it in the browser console on the trades page:</p>
            <div class="console-output" id="diagnosis-script">
// TRADES RENDERING DIAGNOSIS SCRIPT
console.log('üîç [TRADES_RENDERING_DIAGNOSIS] Starting diagnosis...');

// 1. Check if the trades array is being populated correctly
function checkTradesDataFlow() {
  console.log('üîç [DATA_FLOW] Checking trades data flow...');
  
  // Check the actual trades array in React state
  const reactRoot = document.querySelector('#root');
  if (reactRoot) {
    console.log('üîç [DATA_FLOW] React root found');
  }
  
  // Look for trade data in the debug info
  const debugInfo = document.querySelector('.bg-yellow-900\\/20');
  if (debugInfo) {
    const debugText = debugInfo.textContent;
    const tradesCountMatch = debugText.match(/Trades count: (\d+)/);
    const paginationDataMatch = debugText.match(/Pagination data: (\d+)/);
    
    if (tradesCountMatch) console.log('üîç [DATA_FLOW] Trades count from debug:', tradesCountMatch[1]);
    if (paginationDataMatch) console.log('üîç [DATA_FLOW] Pagination data:', paginationDataMatch[1]);
  }
}

// 2. Check conditional rendering logic
function checkConditionalRendering() {
  console.log('üîç [CONDITIONAL_RENDERING] Checking conditional rendering logic...');
  
  // Check if the "No trades" message is showing when it shouldn't
  const noTradesElements = Array.from(document.querySelectorAll('*')).filter(el => 
    el.textContent && el.textContent.includes('No trades yet')
  );
  
  console.log('üîç [CONDITIONAL_RENDERING] "No trades" elements found:', noTradesElements.length);
  
  // Check if trades rows are being rendered
  const tradeRows = document.querySelectorAll('.flashlight-container');
  console.log('üîç [CONDITIONAL_RENDERING] Trade rows found:', tradeRows.length);
  
  // Check the specific condition from the code
  const debugInfo = document.querySelector('.bg-yellow-900\\/20');
  if (debugInfo) {
    const debugText = debugInfo.textContent;
    const loadingMatch = debugText.match(/Loading: (.+)/);
    const tradesCountMatch = debugText.match(/Trades count: (\d+)/);
    const paginationDataMatch = debugText.match(/Pagination data: (\d+)/);
    
    const loading = loadingMatch ? loadingMatch[1] === 'YES' : true;
    const tradesCount = tradesCountMatch ? parseInt(tradesCountMatch[1]) : 0;
    const paginationData = paginationDataMatch ? parseInt(paginationDataMatch[1]) : 0;
    
    console.log('üîç [CONDITIONAL_RENDERING] Condition analysis:');
    console.log('  - loading:', loading);
    console.log('  - trades.length:', tradesCount);
    console.log('  - pagination?.data?.length:', paginationData);
    console.log('  - !loading && !pagination?.data?.length && trades.length === 0:', !loading && !paginationData && tradesCount === 0);
    console.log('  - This would show "No trades" message:', !loading && !paginationData && tradesCount === 0);
  }
}

// 3. Check for CSS/display issues
function checkCSSDisplayIssues() {
  console.log('üîç [CSS_DISPLAY] Checking for CSS display issues...');
  
  // Check if trades container is hidden
  const tradesContainer = document.querySelector('.space-y-3');
  if (tradesContainer) {
    const styles = window.getComputedStyle(tradesContainer);
    console.log('üîç [CSS_DISPLAY] Trades container styles:', {
      display: styles.display,
      visibility: styles.visibility,
      opacity: styles.opacity,
      height: styles.height
    });
  }
  
  // Check for any hidden elements
  const hiddenElements = document.querySelectorAll('[style*="display: none"], [style*="visibility: hidden"]');
  console.log('üîç [CSS_DISPLAY] Hidden elements found:', hiddenElements.length);
}

// 4. Check data structure mismatch
function checkDataStructure() {
  console.log('üîç [DATA_STRUCTURE] Checking for data structure mismatches...');
  
  // Look for trade data in the debug info
  const debugInfo = document.querySelector('.bg-yellow-900\\/20');
  if (debugInfo) {
    console.log('üîç [DATA_STRUCTURE] Debug info found');
    const debugText = debugInfo.textContent;
    console.log('üîç [DATA_STRUCTURE] Full debug info:', debugText);
    
    // Extract specific values
    const userMatch = debugText.match(/User: (.+)/);
    const loadingMatch = debugText.match(/Loading: (.+)/);
    const tradesCountMatch = debugText.match(/Trades count: (\d+)/);
    const paginationDataMatch = debugText.match(/Pagination data: (\d+)/);
    const totalCountMatch = debugText.match(/Total count: (\d+)/);
    const pageMatch = debugText.match(/Page: (\d+) of (\d+)/);
    
    console.log('üîç [DATA_STRUCTURE] Extracted data:');
    if (userMatch) console.log('  - User:', userMatch[1]);
    if (loadingMatch) console.log('  - Loading:', loadingMatch[1]);
    if (tradesCountMatch) console.log('  - Trades count:', tradesCountMatch[1]);
    if (paginationDataMatch) console.log('  - Pagination data:', paginationDataMatch[1]);
    if (totalCountMatch) console.log('  - Total count:', totalCountMatch[1]);
    if (pageMatch) console.log('  - Page:', pageMatch[1], 'of', pageMatch[2]);
  }
}

// 5. Check for JavaScript errors
function checkForErrors() {
  console.log('üîç [ERROR_CHECK] Checking for JavaScript errors...');
  
  // Check for any error elements
  const errorElements = document.querySelectorAll('[class*="error"], [class*="Error"]');
  console.log('üîç [ERROR_CHECK] Error elements found:', errorElements.length);
  
  // Check console for recent errors
  console.log('üîç [ERROR_CHECK] Check the browser console for any JavaScript errors');
}

// Main diagnosis function
function runDiagnosis() {
  console.log('üîç [DIAGNOSIS] Running comprehensive trades rendering diagnosis...');
  console.log('='.repeat(80));
  
  checkTradesDataFlow();
  console.log('-'.repeat(40));
  
  checkConditionalRendering();
  console.log('-'.repeat(40));
  
  checkCSSDisplayIssues();
  console.log('-'.repeat(40));
  
  checkDataStructure();
  console.log('-'.repeat(40));
  
  checkForErrors();
  
  console.log('='.repeat(80));
  console.log('üîç [DIAGNOSIS] Diagnosis complete. Analyze the output above.');
}

// Run the diagnosis
runDiagnosis();
            </div>
            <button class="btn" onclick="copyScript()">Copy Script</button>
        </div>

        <div class="section">
            <h2>Potential Issues & Findings</h2>
            <div id="findings">
                <div class="status warning">
                    <strong>Most Likely Issue:</strong> Based on the code analysis, the problem is likely in the conditional rendering logic on line 1211:
                    <br><code>!loading && !pagination?.data?.length && trades.length === 0</code>
                    <br>This condition might be evaluating to true even when data is present, causing the "No trades" message to display instead of the actual trades.
                </div>
                
                <div class="status error">
                    <strong>Possible Root Causes:</strong>
                    <ol>
                        <li><strong>Data Structure Mismatch:</strong> The fetched data structure might not match what the UI expects</li>
                        <li><strong>State Update Issue:</strong> The trades state might not be updating correctly despite the fetch succeeding</li>
                        <li><strong>Conditional Logic Bug:</strong> The condition for showing trades vs "No trades" might be incorrect</li>
                        <li><strong>Async State Issue:</strong> There might be a timing issue between data fetch and state update</li>
                        <li><strong>CSS Display Issue:</strong> The trades might be rendered but hidden by CSS</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Recommended Fix</h2>
            <div class="status success">
                <strong>Primary Fix:</strong> Update the conditional rendering logic to properly check for trades data:
                <br><br>
                <strong>Current (problematic):</strong>
                <br><code>{!loading && !pagination?.data?.length && trades.length === 0 && (...)}</code>
                <br><br>
                <strong>Fixed:</strong>
                <br><code>{!loading && (trades.length === 0) && (...)}</code>
                <br><br>
                <strong>Explanation:</strong> The issue is that the condition checks both <code>pagination?.data?.length</code> AND <code>trades.length === 0</code>. If the pagination data is populated but the trades array is not (or vice versa), the condition evaluates incorrectly. The fix simplifies this to only check the trades array, which is what's actually being rendered in the map function.
            </div>
        </div>
    </div>

    <script>
        function copyScript() {
            const scriptText = document.getElementById('diagnosis-script').textContent;
            navigator.clipboard.writeText(scriptText).then(() => {
                alert('Diagnosis script copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy script:', err);
                alert('Failed to copy script. Please copy manually.');
            });
        }
    </script>
</body>
</html>